<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/frappe-charts@latest"></script>
    <link rel="stylesheet" href="testCSS.css">
</head>
<body>
    <div class="dropdown">
        <input type="text" class="dropdown-input" id="dropdownInput" placeholder="Search municipality">
        <div class="dropdown-list" id="dropdownList"></div>
    </div>

    <div id="chart"></div>


    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const dropdownInput = document.getElementById("dropdownInput");
            const dropdownList = document.getElementById("dropdownList");
            const dropdown = document.querySelector(".dropdown");

            const fetchMunicipality = async () => {
                const url = "municipalities.json"
                const res = await fetch(url)
                const data = await res.json()   
                //console.log(data)
                return data
            };

            const populateDropdown = async () => {

                dropdownList.innerHTML = '';

                const optionValues = await fetchMunicipality();
                Object.entries(optionValues).forEach(([key, value]) => {
                    const option = document.createElement('div');
                    option.textContent = value;
                    option.dataset.value = key;

                    option.addEventListener('click', () => {
                        dropdownInput.value = value;
                        dropdown.classList.remove('dropdown-active');
                    });
                    dropdownList.appendChild(option)
                });
            }

            function filterOptions() {
                const filterText = dropdownInput.value.toLowerCase();

                const options = dropdownList.children; // these are divs
                Object.values(options).forEach(option => {
                    const text = option.textContent.toLocaleLowerCase();
                    if (text.includes(filterText))
                        option.style.display = ''; // display
                    else
                        option.style.display = 'none'; // don't display
                })
            }

            dropdownInput.addEventListener("focus", function() {
                dropdown.classList.add("dropdown-active");
            });

            dropdownInput.addEventListener("blur", function() {
                // Timeout to allow click event to register before hiding
                setTimeout(() => {
                    dropdown.classList.remove("dropdown-active");
                }, 200);
            });

            dropdownInput.addEventListener("input", filterOptions);
            populateDropdown();
            console.log(dropdownInput.value)
        });

        const jsonQuery = {
            "query": [
                {
                "code": "Vuosi",
                "selection": {
                    "filter": "item",
                    "values": [
                    "1984",
                    "1988",
                    "1992",
                    "1996",
                    "2000",
                    "2004",
                    "2008",
                    "2012",
                    "2017",
                    "2021"
                    ]
                }
                },
                {
                "code": "Alue",
                "selection": {
                    "filter": "item",
                    "values": [ "000000" ]
                }
                },
                {
                "code": "Puolue",
                "selection": {
                    "filter": "item",
                    "values": [
                    "03",
                    "01",
                    "04",
                    "02",
                    "06",
                    "07",
                    "08",
                    "80"
                    ]
                }
                },
                {
                "code": "Tiedot",
                "selection": {
                    "filter": "item",
                    "values": [
                    "osuus_aanista"
                    ]
                }
                }
            ],
            "response": {
                "format": "json-stat2"
            }
            }

        const getData = async () => {
            const url = "https://statfin.stat.fi:443/PxWeb/api/v1/en/StatFin/kvaa/statfin_kvaa_pxt_12g3.px"
            const res = await fetch(url, {
                method: "POST",
                headers: {"content-type": "application/json"},
                body: JSON.stringify(jsonQuery)
            })
            if(!res.ok) {
                return;
            }
            const data = await res.json()
            console.log(data)
            console.log(JSON.stringify(data.dimension.Alue.category.label))

            return data
        }

        const buildChart = async () => {
            const data = await getData()

            const dataValues = data.value;

            const years = Object.values(data.dimension.Vuosi.category.label);

            const parties = Object.values(data.dimension.Puolue.category.label);

            parties.forEach((party, index) => {
                let partySupport = []; // to store the data for each party
                dataValues.forEach((value, i) => {
                    if((i+1) % parties.length === index+1) {
                        partySupport.push(value)
                    }
                })
                parties[index] = {
                    name: party,
                    values: partySupport
                }
            })
            console.log(parties)
            
            const chartData = {
                labels: years,
                datasets: parties
            }

            const chart = new frappe.Chart("#chart", {
                title: "Votes in some municipality",
                data: chartData,
                type: "line",
                height: 450,
                colors: ["#63d0ff", "#363636"]
            })
        }

        buildChart()
        //getData()

    </script>
    
</body>
</html>
